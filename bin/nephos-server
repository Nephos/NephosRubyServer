#!/usr/bin/env ruby

require 'optparse'

begin
  OptionParser.new do |opts|
    opts.banner = "Usage: nephos-server [-p=port] [--debug]"

    $server_port = ENV["SERVER_PORT"] || 8080
    opts.on("-p=nb", "--port=nb", "Port") do |port|
      $server_port = Integer(port)
    end

    opts.on("--debug") do
      $debug = true
    end

  end.parse!

  if $debug
    require_relative "../lib/nephos-server"
  else
    require 'nephos-server'
  end

  if not $debug and
    (not File.exists? "Gemfile.lock" or
     not File.read("Gemfile.lock").split.index("nephos-server"))
    raise InvalidApplication
  end

  puts "Running Nephos::Server version #{Nephos::VERSION}"
  Nephos::Server.start($server_port)

rescue RoutingError => err
  puts "#{err.class}. Check out the documentation and `routes.rb` file: #{err.message}"

rescue => err
  puts "Error: #{err.message}"
end
